name: Deploy to Azure Static Web Apps

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to Azure

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full git history for PR tracking
        submodules: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build MkDocs site
      run: |
        python mkdocs-scripts/build-specs.py
        mkdocs build --strict
        cp staticwebapp.config.json mkdocs-site/
        if [ -d "mkdocs-static" ] && [ "$(ls -A mkdocs-static)" ]; then
          cp -r mkdocs-static/* mkdocs-site/
        fi

    - name: Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "mkdocs-site" # Built site location
        skip_app_build: true # We already built with MkDocs

# NOTE: Before this workflow can run, you need to:
# 1. Create an Azure Static Web Apps resource in Azure Portal
# 2. Get the deployment token from the Azure resource
# 3. Add it as a GitHub secret named AZURE_STATIC_WEB_APPS_API_TOKEN
# 4. See docs/deployment.md for detailed setup instructions
