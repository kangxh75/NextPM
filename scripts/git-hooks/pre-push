#!/bin/bash
# Pre-push hook to track which design spec changes relate to

# Find the 5 most recent specs (excluding README)
mapfile -t SPEC_FILES < <(ls -1t project/specs/*.md 2>/dev/null | grep -v README | head -5)

# Extract spec IDs (filenames without .md)
SPEC_IDS=()
for file in "${SPEC_FILES[@]}"; do
    SPEC_IDS+=("$(basename "$file" .md)")
done

# Get the newest spec as default
NEWEST_SPEC="${SPEC_IDS[0]}"

# Color codes for better visibility
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}        Git Push - Spec Tracking${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
echo ""
echo "Which design spec are these changes related to?"
echo ""

# Display numbered list of specs
if [ ${#SPEC_IDS[@]} -gt 0 ]; then
    echo -e "${CYAN}Recent specs:${NC}"
    for i in "${!SPEC_IDS[@]}"; do
        if [ $i -eq 0 ]; then
            echo -e "  ${GREEN}[$((i+1))]${NC} ${SPEC_IDS[$i]} ${GREEN}(default)${NC}"
        else
            echo -e "  [$((i+1))] ${SPEC_IDS[$i]}"
        fi
    done
    echo ""
fi

echo "Options:"
echo "  - Press ${GREEN}ENTER${NC} to use default (newest spec)"
echo "  - Type a ${GREEN}number${NC} (1-${#SPEC_IDS[@]}) to select from list"
echo "  - Type ${GREEN}full spec ID${NC} if not in list above"
echo "  - Type ${YELLOW}'no'${NC} or ${YELLOW}'none'${NC} to skip spec tracking"
echo ""
echo -n "Your choice: "
read -r USER_INPUT

# Determine which spec to use
RELATED_SPEC=""

# Empty input = use default
if [ -z "$USER_INPUT" ]; then
    RELATED_SPEC="$NEWEST_SPEC"
# Check if user wants to skip
elif [ "$USER_INPUT" = "no" ] || [ "$USER_INPUT" = "none" ] || [ "$USER_INPUT" = "n" ]; then
    echo ""
    echo -e "${YELLOW}✓${NC} Push will proceed without spec tracking"
    echo ""
    exit 0
# Check if input is a number
elif [[ "$USER_INPUT" =~ ^[0-9]+$ ]]; then
    INDEX=$((USER_INPUT - 1))
    if [ $INDEX -ge 0 ] && [ $INDEX -lt ${#SPEC_IDS[@]} ]; then
        RELATED_SPEC="${SPEC_IDS[$INDEX]}"
    else
        echo ""
        echo -e "${YELLOW}Warning:${NC} Invalid number. Please choose 1-${#SPEC_IDS[@]}"
        echo "Push cancelled."
        exit 1
    fi
# Otherwise, treat as full spec ID
else
    RELATED_SPEC="$USER_INPUT"
fi

# Validate spec exists
SPEC_FILE="project/specs/${RELATED_SPEC}.md"
if [ ! -f "$SPEC_FILE" ]; then
    echo ""
    echo -e "${YELLOW}Warning:${NC} Spec file not found: $SPEC_FILE"
    echo ""
    echo -n "Continue anyway? (y/n): "
    read -r CONTINUE
    if [ "$CONTINUE" != "y" ] && [ "$CONTINUE" != "Y" ]; then
        echo ""
        echo "Push cancelled."
        exit 1
    fi
fi

# Store spec ID for post-push hook
echo "$RELATED_SPEC" > .git/PUSH_SPEC_ID

echo ""
echo -e "${GREEN}✓${NC} Changes will be tracked under spec: ${CYAN}$RELATED_SPEC${NC}"
echo -e "${YELLOW}⚠${NC}  Remember to update PM and Dev workflow documentation"
echo ""

exit 0
